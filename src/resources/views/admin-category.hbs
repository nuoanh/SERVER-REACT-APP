{{!-- js for this page --}}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
{{!-- sweet alert --}}
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- jsDeliver -->
<script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazy/1.7.9/jquery.lazy.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazy/1.7.9/jquery.lazy.plugins.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.0/lazysizes.min.js" async=""></script>
<style>
    .lds-roller {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
    }

    .lds-roller div {
        animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        transform-origin: 40px 40px;
    }

    .lds-roller div:after {
        content: " ";
        display: block;
        position: absolute;
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #fff;
        margin: -4px 0 0 -4px;
    }

    .lds-roller div:nth-child(1) {
        animation-delay: -0.036s;
    }

    .lds-roller div:nth-child(1):after {
        top: 63px;
        left: 63px;
    }

    .lds-roller div:nth-child(2) {
        animation-delay: -0.072s;
    }

    .lds-roller div:nth-child(2):after {
        top: 68px;
        left: 56px;
    }

    .lds-roller div:nth-child(3) {
        animation-delay: -0.108s;
    }

    .lds-roller div:nth-child(3):after {
        top: 71px;
        left: 48px;
    }

    .lds-roller div:nth-child(4) {
        animation-delay: -0.144s;
    }

    .lds-roller div:nth-child(4):after {
        top: 72px;
        left: 40px;
    }

    .lds-roller div:nth-child(5) {
        animation-delay: -0.18s;
    }

    .lds-roller div:nth-child(5):after {
        top: 71px;
        left: 32px;
    }

    .lds-roller div:nth-child(6) {
        animation-delay: -0.216s;
    }

    .lds-roller div:nth-child(6):after {
        top: 68px;
        left: 24px;
    }

    .lds-roller div:nth-child(7) {
        animation-delay: -0.252s;
    }

    .lds-roller div:nth-child(7):after {
        top: 63px;
        left: 17px;
    }

    .lds-roller div:nth-child(8) {
        animation-delay: -0.288s;
    }

    .lds-roller div:nth-child(8):after {
        top: 56px;
        left: 12px;
    }

    @keyframes lds-roller {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
<div class="layout"
    style="position: fixed; width: 100%; height: 100%; top: 0; background-color: rgba(75, 74, 74, 0.5); z-index: 100; display: none; ">
    <div class="lds-roller" style="position: absolute; top: 50%;
    left: 40%;
    transform: translate(-50%, -50%);">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>
<div class="all-image-drive"
    style="position: fixed; width: 80%; height: 80%; top: 58%;
    border-left: solid 2px rgb(5, 92, 62);
    padding: 3px;
    left: 50%;
    transform: translate(-50%, -50%);  background-color: rgba(255, 255, 255); z-index: 101; display: none; flex-wrap: wrap; overflow-y: scroll; justify-content: space-between;">
    {{!-- contain all iamge product --}}
</div>

<div class="content-wrapper">
    <div class="row">
        {{!-- detail cate prod --}}
        <div class="col-12 grid-margin stretch-card contain-detail-cate" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Thông tin chi tiết loại sản phẩm</h4>
                    <form class="forms-sample">
                        <div class="form-group">
                            <input type="hidden" class="id-update-cate">
                            <label for="exampleInputName1">Tên danh mục</label>
                            <p class="err-ud-name-cate"></p>

                            <input type="text" class="form-control update-name-cate" id="exampleInputName1"
                                placeholder="Tên sản phẩm" fdprocessedid="ewikud">
                        </div>

                        <div class="form-group">
                            <label for="exampleTextarea1 ">Mô tả loại sản phẩm</label>
                            <p class="err-ud-des-cate"></p>
                            <textarea class="form-control update-des-cate" style="height: 400px;" id="exampleTextarea1"
                                rows="4"></textarea>
                        </div>
                        <button type="button" class="btn btn-primary me-2 btn-submit-update-cate"
                            fdprocessedid="9jz5h">Cập nhật</button>
                        <button type="button" class="btn btn-light btn-cancel-update-cate" fdprocessedid="r0oeaq">Hủy
                            bỏ</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-8 grid-margin stretch-card contain-tbl-cate">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Tất cả các loại sản phẩm hiện đang có</h4>
                    <p class="card-description">
                        Danh sách tất cả các loại sản phẩm đã thêm <code>Admin là người thêm</code>
                    </p>
                    <div class="table-responsive pt-3">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>
                                        Ảnh
                                    </th>
                                    <th>
                                        Tên loại sản phẩm
                                    </th>
                                    <th>
                                        Mô tả
                                    </th>
                                    <th>
                                        Chi tiết
                                    </th>
                                    <th>
                                        Xóa
                                    </th>

                                </tr>
                            </thead>
                            <tbody id="tbl_category">



                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4 grid-margin stretch-card contain-add-cate">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Thêm loại sản phẩm</h4>
                    <p class="card-description">
                        Điền đầy đủ thông tin 1 loại sản phẩm
                    </p>
                    <p class="card-description">
                        Xem về sản phẩm hiện có <code>Hoặc thêm sản phẩm</code><a target="_blank"
                            href="admin-product">Tại đây</a>
                    </p>
                    <form class="forms-sample">
                        <div class="form-group">
                            <label for="exampleInputName1">Tên loại sản phẩm</label>
                            <p class="err-name-cate"></p>
                            <input type="text" class="form-control name-cate" id="exampleInputName1"
                                placeholder="Tên loại sản phẩm">
                        </div>


                        <div class="form-group">
                            <label for="exampleTextarea1">Mô tả</label>
                            <p class="err-des-cate"></p>
                            <textarea class="form-control descript-cate" style="min-height: 200px;"
                                id="exampleTextarea1" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="exampleTextarea1">Chọn ảnh đặc trưng cho danh mục này</label>
                            <button type="button"
                                class="btn btn-outline-primary btn-fw btn-choose-image-cate">Chọn</button>
                            <img src="" class="show-banner-cate" width="100%" alt="">
                        </div>
                        <button type="button" class="btn btn-primary me-2 btn-add-cate">Đăng</button>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    $(document).ready(function () {
        var image_cate;
        //get all cate
        allCategory()
        function allCategory() {
            $.ajax({
                url: '/admin/get-all-category',
                async: true,
                type: 'GET',
                dataType: "json",
                encode: true,
            }).done(function (data) {
                let html = "";
                data.map((cate) => {
                    html += ` <tr>
                                    <td> <img src = `+
                        cate.image + `>
                                        
                                    </td>
                                    <td>
                                        `+ cate.name + `
                                    </td>
                                    <td>
                                        `+ cate.description + `
                                    </td>
                                     <td><button type="button" class="btn btn-primary btn-sm btn-detail-cate" data-id="`+ cate._id + `">chi tiết</button></td>
                                    <td><button type="button" class="btn btn-warning btn-sm btn-delete-cate"  data-id="`+ cate._id + `">xoá</button></td>                                   
                                   
                                </tr>`;
                })
                $("#tbl_category").html(html);
                console.log(data);
            }).then(() => {
                //delete category
                $(".btn-delete-cate").click(function () {
                    $(".layout").css('display', 'block')
                    let idCate = $(this).attr('data-id');
                    let f_idCate = new FormData();
                    f_idCate = { '_id': idCate }
                    Swal.fire({
                        title: 'Bạn có chắc muốn xóa  loại sản phẩm này?',
                        text: "Bạn không thể khôi phục sản phẩm này sau khi xóa!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Đồng ý'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: '/admin/delete-category',
                                type: 'POST',
                                async: false,
                                data: f_idCate,
                                dataType: "json",
                                encode: true,
                            }).done(function (data) {
                                if (data == 'success') {
                                    Swal.fire(
                                        'Xóa thành công!',
                                        'Your file has been deleted.',
                                        'success'
                                    )
                                } else {
                                    console.log(data)
                                }
                            }).then(() => {
                                allCategory()
                                $(".layout").hide()
                            })

                        }
                    })

                })

            }).then(() => {
                //detail category
                $(".btn-detail-cate").click(function () {
                    $(".layout").css('display', 'block');
                    let idCate = $(this).attr('data-id');
                    $(".contain-detail-cate").css('display', 'block');
                    $(".contain-add-cate").hide()
                    $(".contain-tbl-cate").hide();
                    $
                    $.ajax({
                        url: '/admin/get-detail-category/' + idCate + '',
                        async: true,
                        type: 'GET',
                        dataType: "json",
                        encode: true,
                    }).done(function (data) {
                        $(".layout").hide();
                        $(".update-name-cate").val(data.name)
                        $(".update-des-cate").val(data.description);
                        $(".id-update-cate").val(data._id);
                        console.log(data);
                    })
                })
            })
        }
        //add cate
        $(".btn-add-cate").click(function () {
            $(".layout").css('display', 'block')
            $(".err-name-cate").html(" ");
            $(".err-des-cate").html("");
            let validation = true;
            let nameCate = $(".name-cate").val();
            let descriptCate = $(".descript-cate").val();
            if (nameCate == "") {
                validation = false;
                $(".err-name-cate").html('chưa điền tên loại danh mục').css('color', 'red')
            }
            if (descriptCate == "") {
                validation = false;
                $(".err-des-cate").html('chưa điền mô tả loại danh mục').css('color', 'red')
            }
            if (validation == true) {
                //call ajax to add category
                //add-cate-prod
                let form = new FormData();
                form = {
                    name: nameCate,
                    description: descriptCate,
                    image: image_cate
                }
                $.ajax({
                    url: '/admin/add-cate-prod',
                    async: true,
                    type: 'POST',
                    dataType: "json",
                    data: form,
                    encode: true,
                }).done(function (data) {
                    if (data == 'success') {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title: 'Thêm loại sản phẩm thành công',
                            showConfirmButton: false,
                            timer: 1500
                        })
                        $(".name-cate").val(" ");
                        $(".descript-cate").val(" ");
                    }
                }).then(() => {
                    $(".layout").hide()
                    allCategory()
                })
            }

        })

        //cancel updateprod
        $(".btn-cancel-update-cate").click(function () {
            $(".contain-detail-cate").hide()
            $(".contain-tbl-cate").show()
            $(".contain-add-cate").show();
            window.scrollTo(0, 0);
        })

        //submit update category
        $(".btn-submit-update-cate").click(function () {
            let idCate = $(".id-update-cate").val();
            $(".err-ud-name-cate").html(" ");
            $(".err-ud-des-cate").html(" ");
            let permision_submit = true;

            var ud_name_cate = $(".update-name-cate").val();
            var ud_des_cate = $(".update-des-cate").val();
            //cate từ từ đang làm
            if (ud_name_cate == "") {
                $(".err-ud-name-cate").html('Chưa điền tên loại sản phẩm').css('color', 'red');
                permision_submit = false;
            }
            if (ud_des_cate == "") {
                $(".err-ud-des-cate").html('Chưa mô tả loại sản phẩm').css('color', 'red');
                permision_submit = false;
            }

            if (permision_submit) {
                $(".layout").css('display', 'block');

                let form = new FormData();
                form = {
                    _id: idCate,
                    obj: {
                        name: ud_name_cate,
                        description: ud_des_cate
                    }
                }
                //call ajax requesst post to update
                $.ajax({
                    url: '/admin/update-category',
                    async: true,
                    type: 'POST',
                    dataType: "json",
                    data: form,
                    encode: true,
                }).done(function (data) {
                    if (data == 'success') {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title: 'Cập nhật sản phẩm thành công',
                            showConfirmButton: false,
                            timer: 1500
                        })
                    }
                }).then(() => {
                    setTimeout(function () {
                        location.reload(true);
                    }, 1000)
                })
            }

        })

        //image banner cate
        $(".btn-choose-image-cate").click(function () {
            $(".layout").css('display', 'block')
            $.ajax({
                url: '/admin/all-image-company',
                async: true,
                type: 'GET',
                dataType: "json",
                encode: true,
            }).done(function (data) {
                let html = "";
                data.map((item) => {
                    html += `<div class="contain-image" data-id="` + item.id + `"
        style="width: 18%; height: 200px; position: relative; margin-left: 2px; margin-top: 2px">
        <img src="`+ item.thumbnailLink + `" 
            style="object-fit: cover; height: 100%; position: absolute; width: 100%;" alt="">
        <button data-id="` + item.id + `" data-name="` + item.name + `" style="position: absolute; top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);" type="button" class="btn btn-outline-success btn-fw btn-choose-this-image">Chọn ảnh này</button>
    </div>`;
                })
                $(".all-image-drive").html(html)
            }).then(() => {
                $(".all-image-drive").css('display', 'block');
            }).then(() => {
                $(".btn-choose-this-image").click(function () {
                    let idImage = $(this).attr('data-id');
                    image_cate = `https://drive.google.com/uc?id=` + idImage + ``;
                    $(".show-banner-cate").attr('src', image_cate);
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Your work has been saved',
                        showConfirmButton: false,
                        timer: 1500
                    })
                })
            }).then(() => {

            })
        })

        $(".layout").click(function () {
            $(this).hide();
            $(".all-image-drive").hide();
        })
    })

</script>